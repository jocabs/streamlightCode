# app.py
import streamlit as st
import pandas as pd
import glob
import os

st.set_page_config(page_title="NPS Report Viewer", layout="wide")
st.title("üìä NPS Report Viewer (Auto CSV)")

# --- Configuration ---
# Folder where the PowerShell script exports CSV
csv_folder = os.path.expanduser("~/Desktop")  # Change if needed
csv_pattern = os.path.join(csv_folder, "NPS_Report*.csv")  # Match latest CSV

# --- Get latest CSV ---
list_of_files = glob.glob(csv_pattern)
if not list_of_files:
    st.warning(f"No NPS_Report CSV found in folder: {csv_folder}")
else:
    latest_file = max(list_of_files, key=os.path.getctime)
    st.info(f"Using latest CSV: {os.path.basename(latest_file)}")

    try:
        # Read CSV
        df = pd.read_csv(latest_file)

        # Show dataframe
        st.subheader("Report Table")
        st.dataframe(df, use_container_width=True)

        # Filtering example
        st.subheader("Filter Report")
        columns = df.columns.tolist()
        selected_column = st.selectbox("Select a column to filter", columns)
        unique_values = df[selected_column].dropna().unique()
        selected_values = st.multiselect(f"Select {selected_column} value(s)", unique_values, default=unique_values)
        filtered_df = df[df[selected_column].isin(selected_values)]
        st.dataframe(filtered_df, use_container_width=True)

        # Download filtered CSV
        csv = filtered_df.to_csv(index=False).encode('utf-8')
        st.download_button(
            label="üì• Download Filtered CSV",
            data=csv,
            file_name="NPS_Report_filtered.csv",
            mime="text/csv",
            key="download_filtered_csv"
        )

    except Exception as e:
        st.error(f"‚ö†Ô∏è Error reading CSV: {e}")
